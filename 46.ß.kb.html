<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>SCP Foundation - Secure Terminal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    html, body {height: 100%; margin: 0; padding: 0; background: #101417; color: #c5c8c6; font-family: 'Consolas', 'Courier New', monospace;}
    body {display: flex; justify-content: center; align-items: center; min-height: 100vh;}
    .hidden {display:none !important;}
    .glitch {animation: glitch 0.3s linear infinite;}
    .blackout {box-shadow: 0 0 0 6px #c00 inset !important;}
    @keyframes glitch {0%{text-shadow:2px 0 red,-2px 0 blue;}20%{text-shadow:-2px 0 red,2px 0 blue;}40%{text-shadow:2px 0 red,-2px 0 blue;}60%{text-shadow:-2px 0 red,2px 0 blue;}80%{text-shadow:2px 0 red,-2px 0 blue;}100%{text-shadow:0 0 0;}}
    #login-screen {background: #11161a; border-radius: 10px; box-shadow: 0 0 40px #0c0c0c; padding: 40px 32px; min-width:340px; display:flex; flex-direction:column; align-items:center;}
    #login-title {font-size:2em; letter-spacing:2px; margin-bottom:1em;}
    .scp-logo {width: 64px; margin-bottom: 16px;}
    .login-input {background:#222;color:#fff;border:none;border-radius:3px;padding:8px 12px;margin:8px 0;width:220px;}
    .login-btn {background:#c00;border:none;color:#fff;padding:10px 30px;margin-top:18px;border-radius:4px;font-weight:bold;cursor:pointer;letter-spacing:1px;}
    .login-btn:active {background:#900;}
    .login-error {color:#ff4444; margin-top: 8px;}
    #loading-screen {background:rgba(0,0,0,0.98);position:fixed;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:200;}
    .loading-terminal {background:#15181b;color:#0f0;padding:32px;border-radius:8px;font-size:1.2em;box-shadow:0 0 32px #000;}
    .blink {animation: blink 0.8s steps(1) infinite;}
    @keyframes blink {50%{opacity:0;}}
    #desktop {
      width:100vw; height:100vh;
      background:
        repeating-linear-gradient(0deg, #14181e 10px, #090b0f 100px),
        url('data:image/svg+xml;utf8,<svg viewBox="0 0 320 320" width="320" height="320" fill="none" xmlns="http://www.w3.org/2000/svg"><g opacity="0.08"><circle cx="160" cy="160" r="150" stroke="white" stroke-width="24"/><path d="M160 60 L200 160 L160 260 L120 160 Z" fill="white"/></g></svg>') repeat center center fixed;
      background-size: 420px 420px, 320px 320px;
      position:relative;
    }
    .desktop-logo-bg {
      position:fixed;
      left:50%;top:50%;
      transform:translate(-50%,-50%);
      width:540px;height:540px;
      z-index:0;opacity:0.08;
      user-select:none;pointer-events:none;
    }
    .taskbar {position:fixed;bottom:0;left:0;width:100vw;height:40px;background:#191c22;border-top:2px solid #20242a;display:flex;padding:0 10px;z-index:99;}
    .taskbar-btn {margin-right:16px;cursor:pointer;padding:0 10px;line-height:40px;color:#c5c8c6;}
    .taskbar-btn:hover {background:#272b32;}
    .scptitle {padding:24px 0 8px 24px;font-size:1.5em;letter-spacing:1px;position:relative;z-index:2;}
    .window {position:absolute;top:70px;left:80px;width:560px;min-height:340px;background:#181d23;border-radius:6px;box-shadow:0 0 40px #0009;z-index:10;display:flex;flex-direction:column;}
    .window-header {background:#20252e;color:#fff;font-weight:bold;padding:8px 16px;cursor:move;border-radius:6px 6px 0 0;user-select:none;display:flex;justify-content:space-between;}
    .window-close {cursor:pointer;color:#f44;font-weight:bold;}
    .window-content {flex:1;padding:18px 20px;overflow:auto;}
    #terminal-output {height: 220px; overflow-y: auto; background:#1e2228;padding:10px;color:#8fe77b;font-size:1em;border-radius:4px;}
    #terminal-input {width: 100%; background: #23272e; color:#aff;border:none;padding:7px 10px;margin-top:10px;border-radius:3px;}
    .scp-list {max-height: 270px; overflow-y: auto;}
    .scp-entry {background:#23272e;border-left:4px solid #3e8c3a;margin:8px 0;padding:9px 12px;border-radius:3px;cursor:pointer;}
    .scp-entry:hover {background:#2e343b;}
    .camera-feed {width:320px;height:180px;background:#000;position:relative;overflow:hidden;border:2px solid #484;}
    .vhs {width:100%;height:100%;object-fit:cover;filter:contrast(1.1) blur(1px) grayscale(0.5);}
    .camera-overlay {position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;}
    .camera-timestamp {position:absolute;bottom:4px;right:12px;color:#fff;font-size:0.9em;text-shadow:0 0 4px #000;}
    #notes-area {width:100%;height:150px;background:#1a2127;color:#fff;border:none;padding:8px;border-radius:3px;}
    #notes-save {margin-top:10px;background:#48a;color:#fff;border:none;padding:7px 24px;border-radius:3px;cursor:pointer;}
    .chat-window {height:210px;overflow-y:auto;background:#13171c;padding:10px;border-radius:4px;}
    .chat-msg {margin-bottom:10px;}
    .chat-user {font-weight:bold;color:#8cf;}
    .chat-bot {color:#d9d;}
    .chat-input {width:80%;background:#1f2327;color:#fff;border:none;padding:7px 10px;margin-top:10px;border-radius:3px;}
    .chat-send {background:#2e7;border:none;padding:7px 20px;color:#222;border-radius:3px;cursor:pointer;}
    .file-list {list-style:none;padding:0;}
    .file-item {padding:6px 0;cursor:pointer;color:#8ba;border-bottom:1px solid #223;}
    .file-item:hover {background:#21292f;}
    .modal-bg {position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:300;display:flex;justify-content:center;align-items:center;}
    .modal {background:#23272e;color:#fff;padding:32px 28px;border-radius:8px;max-width:420px;text-align:center;}
    .modal-btn {margin-top:20px;background:#c00;color:#fff;padding:10px 30px;border:none;border-radius:4px;font-weight:bold;cursor:pointer;}
    .alarm {color:#fff;background:#c00;animation: alarmflash 0.6s alternate infinite;}
    @keyframes alarmflash {0%{background:#c00;}100%{background:#400;}}
    #fullscreen-hint {position:fixed;top:10px;right:20px;z-index:1000;color:#fff;background:#111a;border-radius:8px;padding:8px 20px;box-shadow:0 0 8px #000b;font-size:1em;}
    #fullscreen-hint button {background:#222;color:#fff;border:none;padding:7px 18px;font-weight:bold;border-radius:4px;cursor:pointer;}
    #fullscreen-hint button:active {background:#333;}
    #profile-window {position:absolute;top:120px;left:320px;width:330px;z-index:9999;}
    #profile-content {background:#282d36;padding:24px;border-radius:12px;color:#fff;text-align:left;box-shadow:0 0 36px #000b;}
    .profile-badge {background:#448;border-radius:8px;padding:4px 14px;color:#fff;margin-right:8px;font-size:0.98em;}
    .profile-badge.o5 {background:#c00;}
    /* === LOOP UPDATE === */
    #loopupdate-overlay {position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:99999;
      background:#000; color:#0f0; display:flex; flex-direction:column; align-items:center; justify-content:center;
      font-family: 'Consolas','Courier New',monospace; transition: background 0.7s;}
    #loopupdate-bg {position:fixed; inset:0;
      background: repeating-linear-gradient(135deg,#15181b 0px,#222 40px,#15181b 80px),
        url('data:image/svg+xml;utf8,<svg viewBox="0 0 320 320" width="320" height="320" fill="none" xmlns="http://www.w3.org/2000/svg"><g opacity="0.09"><circle cx="160" cy="160" r="150" stroke="white" stroke-width="24"/><path d="M160 60 L200 160 L160 260 L120 160 Z" fill="white"/></g></svg>') repeat center center fixed;
      opacity:0.16; z-index:0; pointer-events:none;}
    #loopupdate-main {position:relative; z-index:1; max-width:650px;
      width:88vw; min-height:310px; background:rgba(10,14,24,0.93); border-radius:16px; box-shadow:0 0 64px #000b,0 0 0 12px #c00 inset;
      border:3px solid #c00; padding:32px 32px 24px 32px; display:flex; flex-direction:column; align-items:center;
      animation: loopupdate-flicker 2.7s infinite;}
    @keyframes loopupdate-flicker {
      0%{box-shadow:0 0 44px #c00a,0 0 0 12px #c00 inset;}
      50%{box-shadow:0 0 100px #c008,0 0 0 12px #c00 inset;}
      100%{box-shadow:0 0 44px #c00a,0 0 0 12px #c00 inset;}
    }
    .loopupdate-title {font-size:1.5em; color:#fff; letter-spacing:4px; margin-bottom:8px; font-weight:bold; text-shadow:0 0 4px #c00,0 0 16px #c00a;
      border-bottom:2px solid #c00; padding-bottom:8px; width:92%; text-align:center;}
    #loopupdate-stream {font-size:1.12em; color:#0f0; margin:24px 0 12px 0; min-height:76px; width:97%; letter-spacing:1.4px;
      text-shadow:0 0 4px #090,0 0 21px #0008; white-space:pre-line; font-family: inherit;}
    #loopupdate-warn {color:#ff4444; font-size:1.12em; font-weight:bold; text-align:center; min-height:34px;
      text-shadow:0 0 8px #c00a,0 0 32px #c008; margin-bottom:12px; animation:loopupdate-warn 1s infinite alternate;}
    @keyframes loopupdate-warn {0%{opacity:1;}100%{opacity:0.79;}}
    .loopupdate-footer {color:#ccc; margin-top:20px; font-size:0.98em; letter-spacing:2px;}
    .loopupdate-progressbar {width:94%; height:22px; background:#161a1e; border:1px solid #222; border-radius:5px; margin:8px auto 6px auto; overflow:hidden; box-shadow:0 0 5px #0006;
      position:relative;}
    .loopupdate-progressbar-inner {background:linear-gradient(90deg,#0f0 0%,#c00 100%);
      height:100%; width:0%; transition:width 0.4s; box-shadow:0 0 12px #0f08;}
    .loopupdate-progressbar-label {position:absolute; left:50%; top:1px; transform:translateX(-50%); color:#0f0; font-size:0.93em; text-shadow:0 0 3px #000c;}
    .loopupdate-symbol {font-size:2em; margin-bottom:5px; text-shadow:0 0 14px #c00c,0 0 30px #0ff8; display:inline-block;}
    @media (max-width:700px){
      #loopupdate-main{padding:12px 2vw;}
      .loopupdate-title{font-size:1.01em;}
    }
  </style>
</head>
<body>
<!-- ============================= LOGIN ============================= -->
<div id="login-screen">
  <img class="scp-logo" src="data:image/svg+xml;utf8,<svg width='64' height='64' viewBox='0 0 64 64' fill='none' xmlns='http://www.w3.org/2000/svg'><circle cx='32' cy='32' r='30' stroke='white' stroke-width='4'/><path d='M32 14 L38 32 L32 50 L26 32 Z' fill='white'/></svg>">
  <div id="login-title">SCP Foundation Secure Access</div>
  <input id="login-user" class="login-input" placeholder="Benutzername" autocomplete="off">
  <input id="login-pass" class="login-input" type="password" placeholder="Passwort" autocomplete="off">
  <button class="login-btn" id="login-btn">Anmelden</button>
  <div class="login-error" id="login-error"></div>
</div>
<div id="fullscreen-hint" class="hidden">Vollbild empfohlen! <button onclick="requestFullscreen()">Jetzt aktivieren</button></div>
<!-- ========================= LOADING SCREEN ======================== -->
<div id="loading-screen" class="hidden">
  <div class="loading-terminal">
    <span id="loading-text">Authentifiziere...<span class="blink">|</span></span>
  </div>
</div>
<!-- ============================= DESKTOP ========================== -->
<div id="desktop" class="hidden">
  <div class="desktop-logo-bg">
    <img src="data:image/svg+xml;utf8,<svg viewBox='0 0 320 320' width='320' height='320' fill='none' xmlns='http://www.w3.org/2000/svg'><g opacity='0.12'><circle cx='160' cy='160' r='150' stroke='white' stroke-width='24'/><path d='M160 60 L200 160 L160 260 L120 160 Z' fill='white'/></g></svg>" width="100%" height="100%">
  </div>
  <div class="scptitle">SCP Foundation - Secure Terminal Desktop</div>
  <div class="taskbar">
    <div class="taskbar-btn" onclick="openWindow('terminal')">Terminal</div>
    <div class="taskbar-btn" onclick="openWindow('database')">SCP-Datenbank</div>
    <div class="taskbar-btn" onclick="openWindow('camera')">Kamera</div>
    <div class="taskbar-btn" onclick="openWindow('notes')">Notizen</div>
    <div class="taskbar-btn" onclick="openWindow('chat')">Chat</div>
    <div class="taskbar-btn" onclick="openWindow('explorer')">Datei-Explorer</div>
    <div class="taskbar-btn" onclick="openWindow('updates')">Updates</div>
    <div class="taskbar-btn" onclick="showProfile()">Profil</div>
  </div>
</div>
<div id="modal-overlay" class="hidden"></div>
<!-- ========================== MODULE-VORLAGEN ========================== -->
<template id="tpl-terminal">
  <div class="window" style="top:80px;left:140px;min-width:380px;width:510px">
    <div class="window-header">
      <span>Terminal-Konsole</span>
      <span class="window-close" onclick="closeWindow(this)">✕</span>
    </div>
    <div class="window-content">
      <div id="terminal-output"></div>
      <input id="terminal-input" autocomplete="off" placeholder="Befehl eingeben...">
    </div>
  </div>
</template>
<template id="tpl-database">
  <div class="window" style="top:140px;left:240px;width:520px">
    <div class="window-header">
      <span>SCP-Datenbank</span>
      <span class="window-close" onclick="closeWindow(this)">✕</span>
    </div>
    <div class="window-content scp-list" id="scp-list"></div>
    <div style="margin-top:10px;">
      <input id="search-scp" style="padding:6px;width:170px;" placeholder="SCP suchen/Nummer">
      <button onclick="searchSCPBtn()" style="padding:6px 14px;">Suche</button>
      <button onclick="randomSCP()" style="padding:6px 14px;">Zufalls-SCP</button>
      <button onclick="addSCPBtn()" style="padding:6px 14px;">SCP hinzufügen</button>
    </div>
  </div>
</template>
<template id="tpl-camera">
  <div class="window" style="top:200px;left:320px;width:380px">
    <div class="window-header">
      <span>Kamera-Überwachung</span>
      <span class="window-close" onclick="closeWindow(this)">✕</span>
    </div>
    <div class="window-content">
      <div class="camera-feed">
        <img class="vhs" id="camera-gif" src="" alt="SCP Cam">
        <div class="camera-overlay"></div>
        <div class="camera-timestamp"></div>
      </div>
      <button onclick="nextCameraFeed()" style="margin-top:16px;">Kamera wechseln</button>
    </div>
  </div>
</template>
<template id="tpl-notes">
  <div class="window" style="top:120px;left:560px;width:400px">
    <div class="window-header">
      <span>Notizbuch</span>
      <span class="window-close" onclick="closeWindow(this)">✕</span>
    </div>
    <div class="window-content">
      <textarea id="notes-area" placeholder="Notiz eingeben..."></textarea>
      <button id="notes-save">Speichern</button>
      <div id="notes-status" style="margin-top:10px;color:#6f6;"></div>
    </div>
  </div>
</template>
<template id="tpl-chat">
  <div class="window" style="top:200px;left:520px;width:380px">
    <div class="window-header">
      <span>Chat</span>
      <span class="window-close" onclick="closeWindow(this)">✕</span>
    </div>
    <div class="window-content">
      <div class="chat-window" id="chat-window"></div>
      <input class="chat-input" id="chat-input" autocomplete="off" placeholder="Nachricht...">
      <button class="chat-send" onclick="sendChat()">Senden</button>
    </div>
  </div>
</template>
<template id="tpl-explorer">
  <div class="window" style="top:80px;left:700px;width:360px">
    <div class="window-header">
      <span>Datei-Explorer</span>
      <span class="window-close" onclick="closeWindow(this)">✕</span>
    </div>
    <div class="window-content">
      <ul class="file-list" id="file-list"></ul>
      <div id="file-viewer" style="margin-top:14px;"></div>
    </div>
  </div>
</template>
<template id="tpl-updates">
  <div class="window" style="top:180px;left:420px;width:390px">
    <div class="window-header">
      <span>Update-Zentrale</span>
      <span class="window-close" onclick="closeWindow(this)">✕</span>
    </div>
    <div class="window-content">
      <b>Verfügbare Updates:</b><br><br>
      <button onclick="runUpdate('scp')" style="background:#18a;padding:10px 22px;margin-bottom:12px;">SCP-Update</button> <br>
      <span style="font-size:0.95em;color:#aaa;">Behebt Terminalfehler, setzt System zurück</span><br><br>
      <button onclick="runUpdate('loop')" style="background:#555;padding:10px 22px;margin-bottom:12px;">Loop-Update</button> <br>
      <span style="font-size:0.95em;color:#aaa;">Zeigt Netzwerkstreams, blockiert Eingaben außer 'c'</span><br><br>
      <button onclick="runUpdate('blackout')" style="background:#900;color:#fff;padding:10px 22px;margin-bottom:12px;">Blackout-Update</button> <br>
      <span style="font-size:0.95em;color:#aaa;">Simuliert Stromausfall und Systemreboot</span>
    </div>
  </div>
</template>
<!-- === LOOP UPDATE OVERLAY === -->
<div id="loopupdate-overlay" class="hidden" tabindex="0">
  <div id="loopupdate-bg"></div>
  <div id="loopupdate-main">
    <div class="loopupdate-title">SCP FOUNDATION – SYSTEM UPDATE</div>
    <div id="loopupdate-stream"></div>
    <div id="loopupdate-warn"></div>
    <div class="loopupdate-footer">[Abbrechen: Taste <b>C</b>] | <span id="loopupdate-timer"></span></div>
  </div>
</div>
<!-- === Mitarbeiterprofil-Fenster === -->
<div id="profile-window" class="hidden">
  <div id="profile-content"></div>
</div>
<script>
const clickSound = new Audio("data:audio/wav;base64,UklGRkQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YYAAAD///8AAAB/f3///////wAAAP///wAAAH9/f39/f38AAAAAAAD//w==");
function playClick() { clickSound.currentTime = 0; clickSound.play(); }
const alarmSound = new Audio("data:audio/wav;base64,UklGRlgAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YaAAAP///19ff3//f/9/f/9/f39/f3+/v/9/f3+/v7+/39/f3//f/8AAAD//39/f3//");
const loginScreen = document.getElementById('login-screen');
const loadingScreen = document.getElementById('loading-screen');
const desktop = document.getElementById('desktop');
const loginBtn = document.getElementById('login-btn');
const loginUser = document.getElementById('login-user');
const loginPass = document.getElementById('login-pass');
const loginError = document.getElementById('login-error');
const fullscreenHint = document.getElementById('fullscreen-hint');

let clearanceLevel = 1; // Default, 5 = O5

loginBtn.onclick = function() {
  if (loginPass.value === "90105") {
    clearanceLevel = 3;
    proceedLogin();
  } else if (loginPass.value === "2587") {
    clearanceLevel = 5;
    proceedLogin();
    setTimeout(()=>showModal("<h2>O5-LEVEL FREIGESCHALTET</h2><p>Willkommen, O5-Mitarbeiter.</p><button class='modal-btn' onclick='hideModal()'>OK</button>"), 1100);
  } else {
    loginError.textContent = "Falsches Passwort!";
    playClick();
  }
};

function proceedLogin() {
  loginError.textContent = "";
  playClick();
  loginScreen.classList.add('hidden');
  fullscreenHint.classList.add('hidden');
  loadingScreen.classList.remove('hidden');
  startLoading();
  setTimeout(requestFullscreen, 300);
}

function startLoading(){
  let text = "Authentifiziere Terminal...\n";
  let dots = 0, step = 0;
  const loadingText = document.getElementById('loading-text');
  const loadingSteps = [
    "Zugriff auf Foundation-Intranet...",
    "Überprüfung der Clearance...",
    "Lade SCP-Datenbank...",
    "Initialisiere Module...",
    "Systemstart abgeschlossen."
  ];
  const interval = setInterval(() => {
    if(step < loadingSteps.length) {
      loadingText.innerHTML = loadingSteps[step] + "<span class='blink'>|</span>";
      playClick();
      step++;
    } else {
      clearInterval(interval);
      setTimeout(()=>{
        loadingScreen.classList.add('hidden');
        showDesktop();
      }, 700);
    }
  }, 1100);
}
function showDesktop() {
  desktop.classList.remove('hidden');
  openWindow('terminal');
}
let openWindows = {};
function openWindow(type) {
  playClick();
  if(openWindows[type]) {
    openWindows[type].style.zIndex = Object.keys(openWindows).length + 10;
    return;
  }
  let tpl = document.getElementById(`tpl-${type}`);
  if (!tpl) return;
  let wnd = tpl.content.firstElementChild.cloneNode(true);
  desktop.appendChild(wnd);
  wnd.querySelector('.window-header').onmousedown = function(e){
    let x = e.clientX, y = e.clientY, startLeft = wnd.offsetLeft, startTop = wnd.offsetTop;
    function move(ev){
      wnd.style.left = (startLeft + ev.clientX - x) + "px";
      wnd.style.top  = (startTop  + ev.clientY - y) + "px";
    }
    function up(){document.removeEventListener('mousemove',move);document.removeEventListener('mouseup',up);}
    document.addEventListener('mousemove',move);
    document.addEventListener('mouseup',up);
  };
  openWindows[type]=wnd;
  switch(type) {
    case 'terminal': initTerminal(wnd); break;
    case 'database': initDatabase(wnd); break;
    case 'camera':   initCamera(wnd); break;
    case 'notes':    initNotes(wnd); break;
    case 'chat':     initChat(wnd); break;
    case 'explorer': initExplorer(wnd); break;
    case 'updates':  initUpdates(wnd); break;
  }
}
function closeWindow(btn){
  playClick();
  let wnd = btn.closest('.window');
  for(let k in openWindows) if(openWindows[k]===wnd) delete openWindows[k];
  wnd.remove();
}

/* ===================== TERMINAL ===================== */
function initTerminal(wnd){
  const termOut = wnd.querySelector('#terminal-output');
  const termIn  = wnd.querySelector('#terminal-input');
  let history = [];
  let histPos = 0;
  function log(line){ termOut.innerHTML += `<div>> ${line}</div>`; termOut.scrollTop=99999;}
  function process(cmd){
    history.push(cmd); histPos = history.length;
    if(randomNetworkError()) { log(randomNetworkError()); return; }
    // Hilfe
    if(cmd==="help") log(`Verfügbare Befehle: help, list, open scp-###, clear, decrypt file42, alarm, glitch, camera, unlock, random, date, updates, profile, badge, upgrade clearance, mission, shred file42, lock scp-###, archive scp-###, test scp-###, audio scp-049, video scp-096, blackout, explorer, chat, notes, search <text>, scp random, add scp <Num> <Name> <Class>, iris, sankara, goc, scp-079 takeover`);
    // SCP list
    else if(cmd==="list") log("SCP-Dateien: " + SCP_ENTRIES.map(e=>'SCP-'+e.num).slice(0,10).join(', ') + " ...");
    // SCP öffnen
    else if(cmd.startsWith("open scp-")) {
      let num = cmd.split("-")[1];
      log(`Öffne SCP-${num}-Datei...`);
      openWindow('database');
      viewSCP(num);
    }
    // Terminal
    else if(cmd==="clear") termOut.innerHTML="";
    else if(cmd==="alarm") triggerAlarm();
    else if(cmd==="glitch") triggerGlitch();
    else if(cmd==="camera") { openWindow('camera'); log("Kamera-App geöffnet."); }
    else if(cmd==="notes") { openWindow('notes'); log("Notizbuch geöffnet."); }
    else if(cmd==="explorer") { openWindow('explorer'); log("Datei-Explorer geöffnet."); }
    else if(cmd==="chat") { openWindow('chat'); log("Chat geöffnet."); }
    else if(cmd==="updates") { openWindow('updates'); log("Update-Zentrale geöffnet."); }
    else if(cmd==="loop download" || cmd==="loop-update" || cmd==="loopupdate" || cmd==="download loop") {
      log("Starte Loop-Update ...");
      runUpdate('loop');
    }
    else if(cmd==="date") log("Systemzeit: "+(new Date()).toLocaleString());
    else if(cmd==="random") log("Würfelergebnis: " + (1+Math.floor(Math.random()*100)));
    else if(cmd==="decrypt file42") {
      log("Datei entschlüsselt! [Geheimer Inhalt freigeschaltet]");
      FILES.push({name:"secret_file42.txt", type:"secret", content:"ACCESS GRANTED: SCP-Alpha Testprotokoll freigeschaltet.\nCode: ALPHA-19"});
    }
    else if(cmd==="unlock") {
      log("Geheimer Zugang entdeckt! SCP-Alpha freigeschaltet.");
      SCP_ENTRIES.push({num:"A", name:"SCP-Alpha", class:"Thaumiel", short:"Synthetische Foundation-Entität.", full:"SCP-Alpha ist eine KI-basierte Supervisoreinheit mit unbekannten Fähigkeiten."});
    }
    // Erweiterte Features
    else if(cmd==="profile") showProfile();
    else if(cmd==="upgrade clearance") {
      if(clearanceLevel<5) {
        clearanceLevel++;
        log("Clearance-Level erhöht: "+clearanceLevel);
      } else log("Maximales Clearance-Level erreicht.");
    }
    else if(cmd==="badge") log("Erworbene Badges: "+(clearanceLevel==5?"O5, Secure, Insider":"Secure"));
    else if(cmd==="mission") showModal("<b>Mission:</b> Überprüfe SCP-173 und berichte an O5.<br><button class='modal-btn' onclick='hideModal()'>OK</button>");
    else if(cmd==="shred file42") {
      if(clearanceLevel==5){
        log("Datei file42 wurde unwiderruflich gelöscht.");
        FILES = FILES.filter(f=>f.name!=="secret_file42.txt");
      } else log("Nur O5 darf Akten vernichten.");
    }
    else if(cmd.startsWith("lock scp-")) log("SCP-Datei gesperrt.");
    else if(cmd.startsWith("archive scp-")) log("SCP-Datei ins Archiv verschoben.");
    else if(cmd.startsWith("test scp-")) log("Testprotokoll für SCP gestartet.");
    else if(cmd==="audio scp-049") log("Audio-Log zu SCP-049 wird abgespielt...");
    else if(cmd==="video scp-096") log("Video-Feed SCP-096 wird wiedergegeben...");
    else if(cmd==="blackout") triggerAlarm();
    else if(cmd.startsWith("search ")) searchSCP(cmd.slice(7));
    else if(cmd==="scp random") randomSCP();
    else if(cmd.startsWith("add scp ")) {
      if (clearanceLevel === 5) {
        let parts = cmd.split(" ");
        if(parts.length>=5){
          SCP_ENTRIES.push({num:parts[2], name:parts[3], class:parts[4], short:"Benutzerdefiniert", full:"Vom O5 hinzugefügt."});
          log("Benutzerdefiniertes SCP hinzugefügt.");
        } else log("Syntax: add scp <Nummer> <Name> <Class>");
      } else log("Nur O5 darf SCPs hinzufügen.");
    }
    // Easter-Eggs
    else if(cmd==="iris") log("Zugang zu SCP-105 freigeschaltet.");
    else if(cmd==="sankara") log("Zugang zu SCP-1440 freigeschaltet.");
    else if(cmd==="goc") log("Zugang: Global Occult Coalition Datenbank.");
    // SCP-079 Event
    else if(cmd==="scp-079 takeover") {
      log("SCP-079 übernimmt das Terminal...");
      termOut.innerHTML += "<div style='color:#f44;font-weight:bold;'>[SCP-079] Ihr seid jetzt in meinem System!</div>";
      setTimeout(()=>{termOut.innerHTML += "<div>[SCP-079] Reboot erforderlich.</div>";}, 2500);
    }
    else log("Unbekannter Befehl. (help für Hilfe)");
  }
  termIn.onkeydown=function(e){
    if(e.key==="Enter"){
      let v=termIn.value.trim();
      if(v){ log(v); process(v); termIn.value="";}
    } else if(e.key==="ArrowUp"){
      if(histPos>0) histPos--; termIn.value=history[histPos]||"";
    } else if(e.key==="ArrowDown"){
      if(histPos<history.length-1) histPos++; termIn.value=history[histPos]||"";
    }
  };
  log("Terminal bereit. (help für Befehle)");
}

/* ===================== SCP-DATENBANK ===================== */
const SCP_ENTRIES = [
  {num:"001", name:"Dr. Clef's Proposal", class:"Keter", short:"Weltuntergangsszenario", full:"SCP-001 ist eine von mehreren 'Proposal'-Dateien. Zugang nur für O5-Personal."},
  {num:"049", name:"Der Seuchenarzt", class:"Euclid", short:"Humanoide Entität mit 'Heil'-Fähigkeit.", full:"SCP-049 ist ein humanoides Wesen mit dem Aussehen eines Pestdoktors. ..."},
  {num:"079", name:"Alte KI", class:"Euclid", short:"Bösartige künstliche Intelligenz.", full:"SCP-079 ist ein alter Apple II Computer mit Bewusstsein."},
  {num:"096", name:"Der Schüchterne", class:"Euclid", short:"Reagiert extrem auf Sichtung seines Gesichts.", full:"SCP-096 ist ein blasses, dünnes humanoides Wesen, das ..."},
  {num:"106", name:"Der alte Mann", class:"Keter", short:"Korrosive Durchdringung, extradimensional.", full:"SCP-106 ist eine humanoide Entität, die durch Materie 'wandern' kann."},
  {num:"173", name:"Die Statue", class:"Euclid", short:"Bewegt sich nur unbeobachtet. Extrem gefährlich.", full:"SCP-173 ist eine animierte Statue, extrem schnell und tödlich. Ursprungsort unbekannt."},
  {num:"294", name:"Getränkemaschine", class:"Euclid", short:"Gibt jede beliebige Flüssigkeit aus.", full:"SCP-294 ist ein Kaffeeautomat, der alles ausgeben kann, was per Tastatur eingegeben wird."},
  {num:"343", name:"'Gott'", class:"Safe", short:"Humanoide Entität mit göttlichen Eigenschaften.", full:"SCP-343 bezeichnet sich selbst als Gott und kann überall erscheinen."},
  {num:"427", name:"Heilungsanhänger", class:"Safe", short:"Heilt, aber verändert den Körper.", full:"SCP-427 ist ein kleiner Anhänger, der biologische Regeneration beschleunigt."},
  {num:"500", name:"Rote Pillen", class:"Safe", short:"Heilt jede Krankheit.", full:"SCP-500 ist ein Behälter mit roten Pillen, die jede Krankheit heilen können."},
  {num:"682", name:"Das unzerstörbare Reptil", class:"Keter", short:"Extrem feindseliges, regeneratives Wesen.", full:"SCP-682 ist ein großes, reptilienartiges Lebewesen mit außergewöhnlicher Stärke und ..."},
];
function initDatabase(wnd){
  const list = wnd.querySelector('#scp-list');
  list.innerHTML = "";
  SCP_ENTRIES.slice(0,50).forEach(e => {
    let div = document.createElement('div');
    div.className = "scp-entry";
    div.innerHTML = `<b>SCP-${e.num}</b> <span style="color:#aaa;">[${e.class}]</span><br><small>${e.short}</small>`;
    div.onclick = ()=>viewSCP(e.num);
    list.appendChild(div);
  });
  if(SCP_ENTRIES.length>50){
    let more = document.createElement('div');
    more.style.color="#888"; more.style.fontSize="0.87em";
    more.innerHTML = "[... weitere SCPs vorhanden: "+SCP_ENTRIES.length+"]";
    list.appendChild(more);
  }
  // Suche, Zufall, Hinzufügen Buttons
  wnd.querySelector("#search-scp").onkeydown = function(e){
    if(e.key==="Enter") searchSCPBtn();
  };
}
function viewSCP(num){
  let e = SCP_ENTRIES.find(x=>x.num==num);
  if(!e) return;
  showModal(`<h3>SCP-${e.num} – ${e.name}</h3><div><b>Class:</b> ${e.class}</div><p>${e.full}</p><button class="modal-btn" onclick="hideModal()">Schließen</button>`);
}
function searchSCPBtn(){
  let val = document.getElementById("search-scp").value.trim();
  searchSCP(val);
}
function searchSCP(term){
  let results = SCP_ENTRIES.filter(e=>e.num.includes(term) || e.name.toLowerCase().includes(term.toLowerCase()));
  if(results.length==0) showModal("Keine SCPs gefunden.<br><button class='modal-btn' onclick='hideModal()'>OK</button>");
  else results.forEach(e=>viewSCP(e.num));
}
function randomSCP(){
  let e = SCP_ENTRIES[Math.floor(Math.random()*SCP_ENTRIES.length)];
  viewSCP(e.num);
}
function addSCPBtn(){
  if(clearanceLevel<5){
    showModal("Nur O5-Personal kann SCPs hinzufügen.<br><button class='modal-btn' onclick='hideModal()'>OK</button>");
    return;
  }
  showModal(`<h3>Neues SCP hinzufügen</h3>
    <div><input id="scp-add-num" style="padding:6px;width:60px;" placeholder="Nummer"></div>
    <div><input id="scp-add-name" style="padding:6px;width:120px;" placeholder="Name"></div>
    <div><input id="scp-add-class" style="padding:6px;width:90px;" placeholder="Class"></div>
    <div><textarea id="scp-add-full" style="width:90%;height:60px;" placeholder="Beschreibung"></textarea></div>
    <button class='modal-btn' onclick='addSCPFromModal()'>Speichern</button>`);
}
function addSCPFromModal(){
  let num = document.getElementById("scp-add-num").value.trim();
  let name = document.getElementById("scp-add-name").value.trim();
  let cl = document.getElementById("scp-add-class").value.trim();
  let full = document.getElementById("scp-add-full").value.trim();
  if(!num || !name || !cl || !full) return;
  SCP_ENTRIES.push({num:num, name:name, class:cl, short:"Benutzerdefiniert", full:full});
  hideModal();
  showModal("SCP erfolgreich hinzugefügt!<br><button class='modal-btn' onclick='hideModal()'>OK</button>");
}

/* ===================== KAMERA ===================== */
const CAMERA_FEEDS = [
  {src:"data:image/gif;base64,R0lGODlhQAAgAKEAAP///wAAACH5BAEKAAEALAAAAABAAAgAAAIejI+py+0No...fake...",desc:"SCP-173 Observation Room"},
  {src:"data:image/gif;base64,R0lGODlhQAAgAKIAAAAAAP///wAAAMLCwpKSklpaWgAAACH5BAEKAAMALAAAAABAAAgAAAM2SLrc/jDKSau9OOvNu/9gKI5kEokFADs=",desc:"Site-19 Korridor C"},
  {src:"data:image/gif;base64,R0lGODlhQAAgAPcAAAAAAP///wAAACH5BAEKAAgALAAAAABAAAgAAAI0hI+py+0P...",desc:"Zelle SCP-096"},
  {src:"data:image/gif;base64,R0lGODlhQAAgAKEAAAAAAP///wAAACH5BAEKAAEALAAAAABAAAgAAAIfhI+py+0Po5y02ouzPgUAOw==",desc:"Wachraum Alpha"},
  {src:"data:image/gif;base64,R0lGODlhQAAgAKEAAAAAAP///wAAACH5BAEKAAMALAAAAABAAAgAAAINhI+pyw9gJwUAOw==",desc:"Außengelände - Nachtsicht"},
];
let currentCam = 0;
function initCamera(wnd){
  updateCameraFeed(wnd);
}
function updateCameraFeed(wnd){
  let cam = CAMERA_FEEDS[currentCam];
  wnd.querySelector('#camera-gif').src = cam.src;
  let d = new Date();
  wnd.querySelector('.camera-timestamp').textContent = cam.desc+" | "+d.toLocaleString();
}
function nextCameraFeed(){
  currentCam = (currentCam+1)%CAMERA_FEEDS.length;
  let wnd = openWindows['camera'];
  if(wnd) updateCameraFeed(wnd);
}

/* ===================== NOTIZEN ===================== */
function initNotes(wnd){
  let area = wnd.querySelector('#notes-area');
  let status = wnd.querySelector('#notes-status');
  area.value = localStorage.getItem('scpNotes') || "";
  wnd.querySelector('#notes-save').onclick = function(){
    localStorage.setItem('scpNotes',area.value);
    status.textContent = "Gespeichert! ("+new Date().toLocaleTimeString()+")";
    setTimeout(()=>status.textContent="",2000);
    playClick();
  };
}

/* ===================== CHAT ===================== */
const CHAT_BOTS = [
  {name:"Dr. Bright", avatar:"🧑‍🔬", responses:[
    "Melde dich bei der nächsten Sicherheitsbesprechung!",
    "Hast du den Code im Bericht 27 gefunden?",
    "Ich beobachte ungewöhnliche Aktivitäten im Sektor C."
  ]},
  {name:"Sicherheitsdienst", avatar:"🛡️", responses:[
    "Achtung: SCP-███ Aktivität erhöht.",
    "Bitte Status prüfen: SCP-173 Zelle.",
    "Warnung: Systemanomalie erkannt.",
    "Netzwerkverbindung kurzzeitig unterbrochen."
  ]},
  {name:"Dr. Gears", avatar:"👨‍💼", responses:[
    "Denk an das Testprotokoll für SCP-682.",
    "Achte auf Systemanomalien.",
    "Verschlüsselte Datei 42 wurde aktualisiert.",
    "Verbindung schwach, bitte warten..."
  ]},
];
let chatBot = 0;
function initChat(wnd){
  const chatWin = wnd.querySelector('#chat-window');
  const chatInput = wnd.querySelector('#chat-input');
  chatWin.innerHTML = "";
  function botReply(){
    let bot = CHAT_BOTS[chatBot];
    let msg = bot.responses[Math.floor(Math.random()*bot.responses.length)];
    chatWin.innerHTML += `<div class="chat-msg"><span class="chat-user">${bot.avatar} ${bot.name}:</span> <span class="chat-bot">${msg}</span></div>`;
    chatWin.scrollTop=99999;
    chatBot = (chatBot+1)%CHAT_BOTS.length;
    if(Math.random()<0.08) triggerWarning("Er beobachtet dich...");
  }
  wnd.querySelector('.chat-send').onclick = sendChat = function(){
    let val = chatInput.value.trim();
    if(!val) return;
    chatWin.innerHTML += `<div class="chat-msg"><span class="chat-user">🧑‍💻 Du:</span> ${val}</div>`;
    chatWin.scrollTop=99999;
    chatInput.value="";
    setTimeout(botReply, 900+Math.random()*800);
    playClick();
  };
}

/* ===================== DATEI-EXPLORER ===================== */
const FILES = [
  {name:"scp-173.log", type:"scp", content:"SCP-173 Bewegungsprotokoll ... [Testprotokoll anzeigen]"},
  {name:"test_report_682.txt", type:"test", content:"Testbericht: SCP-682 vs SCP-173 ..."},
  {name:"incident_alpha.txt", type:"incident", content:"Anomaly Detected – Site 13 Unterbrechung..."},
  {name:"audio_log_049.mp3", type:"audio", content:"[Audio Log: SCP-049 Gespräch.]" },
  {name:"video_feed_096.mp4", type:"video", content:"[Video Feed: SCP-096 Zelle]" },
];
function initExplorer(wnd){
  const list = wnd.querySelector('#file-list');
  const viewer = wnd.querySelector('#file-viewer');
  list.innerHTML = "";
  FILES.forEach(file => {
    let li = document.createElement('li');
    li.className = "file-item";
    li.textContent = file.name;
    li.onclick = ()=>{ 
      if(file.type==="audio"){
        viewer.innerHTML = "Audio-Log wird abgespielt... <br><audio src='' controls autoplay></audio>";
      } else if(file.type==="video"){
        viewer.innerHTML = "Video-Feed wird wiedergegeben... <br><video src='' controls autoplay></video>";
      } else {
        viewer.innerHTML = `<pre>${file.content}</pre>`;
      }
      playClick(); 
    };
    list.appendChild(li);
  });
}

/* ===================== UPDATES ===================== */
function initUpdates(wnd){ /* Placeholder, siehe Button-onclicks */ }
function runUpdate(type){
  if(type!=='loop'){ old_runUpdate(type); return; }
  loopUpdateActive=true;
  showLoopUpdateOverlay();
}

/* ===================== LOOP-UPDATE (IMMERSIV, VOLLBILD, WIEDERHOLUNG) ===================== */
let loopUpdateActive = false;
let loopUpdateTouchCount = 0;
let loopUpdateLastTap = 0;
function showLoopUpdateOverlay(){
  const overlay = document.getElementById('loopupdate-overlay');
  overlay.classList.remove('hidden');
  overlay.focus();
  let step = 0, warnstep=0, timer=0, tmo, tmoWarn, tmoTimer, tmoProgress;
  let finishedOnce = false;

  // Sounds – als kurze Loading/Glitch/Beep-Sounds (Base64)
  const beep1 = new Audio("data:audio/wav;base64,UklGRhoAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAAAgP8AgP8AAAAAAAAAAAAAAP8AAAAAAP8AAAAAAACAAAD//wAA");
  const beep2 = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAAAAP8AAACAAAD/AAD/AAAAAAD/AAAAAAD/AAAAAAD/AAD/AAD/AAD/AAAAAA==");
  const beep3 = new Audio("data:audio/wav;base64,UklGRjgAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAAAAP8AAAD/AAAAAAD/AAAAAIAAAACAAAD/AAAAAAD/AAD/AAAAAA==");
  function playRndBeep(){
    [beep1,beep2,beep3][Math.floor(Math.random()*3)].currentTime=0;
    [beep1,beep2,beep3][Math.floor(Math.random()*3)].play();
  }

  // Streams & Warnungen
  const streams = [
    {symbol:"⏳", text:"[SYSTEM] Lade Foundation-Systemkomponenten..."},
    {symbol:"📡", text:"[NETZ] Verbinde zu SCP Foundation Secure-Net..."},
    {symbol:"✔️", text:"[OK] Verbindung zu Site-19 Terminal hergestellt."},
    {symbol:"🎥", text:"[KAMERA] SCP-173 Observation Room: Live-Feed abgerufen."},
    {symbol:"⚠️", text:"[WARNUNG] SCP-173 kurzzeitig nicht erkannt."},
    {symbol:"📉", text:"[NETZWERK] Paketverlust: 82%. Wiederherstellung läuft..."},
    {symbol:"💾", text:"[SYSTEM] Foundation-Datenbank wird gesichert..."},
    {symbol:"⚡", text:"[KAMERA] SCP-682 Zelle: Verbindung instabil."},
    {symbol:"🛑", text:"[GLITCH] Video-Feed: Störung erkannt."},
    {symbol:"🚨", text:"[ALARM] SCP-███ Aktivität erhöht – Zugriff beschränkt."},
    {symbol:"🔍", text:"[ANALYSE] Überwachungssysteme werden überprüft..."},
    {symbol:"❌", text:"[ERROR] Netzwerkunterbrechung – Wiederherstellung in Arbeit..."},
    {symbol:"🔒", text:"[SECURITY] Zugriff von nicht autorisiertem Knoten erkannt."},
    {symbol:"🔁", text:"[OK] Systemschutz aktiviert. SCP-Update läuft."},
    {symbol:"🤖", text:"[FEHLER] SCP-079: Ungewöhnliche Aktivität."},
    {symbol:"🗄️", text:"[WARNUNG] Foundation-Kernprotokolle werden neu geladen."},
    {symbol:"🖤", text:"[KAMERA] Site-13: Schwarzes Bild. Kein Signal."},
    {symbol:"🌀", text:"[GLITCH] SCP-096 Zelle: Feed flackert massiv."},
    {symbol:"🚨", text:"[SECURITY] Protokoll: Emergency Lockdown INITIATED."},
    {symbol:"✅", text:"[SYSTEM] Update abgeschlossen. Sicherheit wiederhergestellt."}
  ];
  const warnings = [
    "Warnung: Netzwerkverbindung instabil.",
    "Achtung: SCP-███ Aktivität außerhalb Norm.",
    "Verbindung zu mehreren SCP-Containments verloren.",
    "Sicherheitsprotokoll ausgelöst.",
    "Kritischer Fehler: Notfallprotokoll aktiviert.",
    "Foundation-Kernprotokolle werden neu geladen.",
    "SCP-ALERT: Nicht autorisierter Zugriff erkannt!",
    "Live-Feed: Massiver Paketverlust.",
    "Systemschutz läuft im Notfallmodus.",
    "!!! SYSTEMSTÖRUNG – Eingabe gesperrt !!!",
    "",
    ""
  ];

  function showStep(idx){
    const s = streams[idx % streams.length];
    document.getElementById('loopupdate-stream').innerHTML =
      `<span class="loopupdate-symbol">${s.symbol}</span>  ${s.text}<br><div class='loopupdate-progressbar'><div class='loopupdate-progressbar-inner' id='loopupdate-pbar'></div><span class='loopupdate-progressbar-label' id='loopupdate-pbar-label'>${Math.floor((idx+1)/streams.length*100)}%</span></div>`;
    document.getElementById('loopupdate-pbar').style.width = `${Math.min(100,Math.floor((idx+1)/streams.length*100))}%`;
    document.getElementById('loopupdate-pbar-label').textContent = `${Math.min(100,Math.floor((idx+1)/streams.length*100))}%`;
    playRndBeep();
    if(s.symbol==="🛑"||s.symbol==="🌀"||s.symbol==="🖤"){
      document.getElementById('loopupdate-bg').style.opacity="0.22";
      document.getElementById('loopupdate-main').style.filter="blur(2.5px) contrast(1.4) hue-rotate(10deg)";
    } else {
      document.getElementById('loopupdate-bg').style.opacity="0.16";
      document.getElementById('loopupdate-main').style.filter="";
    }
  }
  function doStepLoop(){
    showStep(step);
    step++;
    if(step<streams.length){
      tmo = setTimeout(doStepLoop, 1300+Math.random()*600);
    } else {
      // Abschluss
      finishedOnce = true;
      setTimeout(() => {
        playRndBeep();
        document.getElementById('loopupdate-stream').innerHTML =
          `<span class="loopupdate-symbol">✅</span>  [SYSTEM] Update erfolgreich abgeschlossen.<br><div class='loopupdate-progressbar'><div class='loopupdate-progressbar-inner' style='width:100%'></div><span class='loopupdate-progressbar-label'>100%</span></div>`;
        document.getElementById('loopupdate-warn').innerHTML = "<span style='color:#6f6;'>System wurde stabilisiert. Update wird zur Sicherheit wiederholt.</span>";
        setTimeout(() => {
          if(loopUpdateActive) {
            step = 0;
            doStepLoop(); // Wiederhole den Vorgang bis abgebrochen!
          }
        }, 1700);
      }, 900);
    }
  }
  function doWarn(){
    document.getElementById('loopupdate-warn').innerHTML = warnings[warnstep%warnings.length];
    warnstep++;
    tmoWarn = setTimeout(doWarn, 1200+Math.random()*500);
  }
  function doTimer(){
    timer++;
    document.getElementById('loopupdate-timer').textContent = timer+"s";
    tmoTimer=setTimeout(doTimer,1000);
  }
  step=0; warnstep=0; timer=0; finishedOnce=false;
  doStepLoop(); doWarn(); doTimer();

  // Tastensperre außer "c"
  overlay.tabIndex=0;
  overlay.focus();
  document.onkeydown = function(ev){
    if(!loopUpdateActive) return;
    if(ev.key && ev.key.toLowerCase()==='c'){
      clearTimeout(tmo); clearTimeout(tmoWarn); clearTimeout(tmoTimer);
      overlay.classList.add('hidden');
      loopUpdateActive=false;
      document.onkeydown = null;
      showModal("Loop-Update abgebrochen.<br><button class='modal-btn' onclick='hideModal()'>OK</button>");
    } else {
      ev.preventDefault(); ev.stopPropagation();
      return false;
    }
  };
  // Touch für Handy: 5x schnell tippen
  overlay.ontouchstart = function(){
    let now = Date.now();
    if(now-loopUpdateLastTap<650){
      loopUpdateTouchCount++;
    } else {
      loopUpdateTouchCount=1;
    }
    loopUpdateLastTap=now;
    if(loopUpdateTouchCount>=5){
      clearTimeout(tmo); clearTimeout(tmoWarn); clearTimeout(tmoTimer);
      overlay.classList.add('hidden');
      loopUpdateActive=false;
      overlay.ontouchstart=null;
      document.onkeydown = null;
      showModal("Loop-Update abgebrochen.<br><button class='modal-btn' onclick='hideModal()'>OK</button>");
    }
  };
}
// Bewahre Originalfunktion für andere Updates
let old_runUpdate = window.runUpdate;
window.runUpdate = runUpdate;

/* ===================== MODALE/OVERLAYS ===================== */
function showModal(html){
  let overlay = document.getElementById('modal-overlay');
  overlay.innerHTML = `<div class="modal">${html}</div>`;
  overlay.classList.remove('hidden');
  playClick();
}
function hideModal(){
  document.getElementById('modal-overlay').classList.add('hidden');
}

/* ===================== EVENTS / GLITCHES / ALARME ===================== */
function triggerAlarm(){
  showModal(`<div class="alarm">!! ALARM !!<br>SCP-███ ist entkommen!<br><button class="modal-btn" onclick="hideModal()">OK</button></div>`);
  alarmSound.currentTime=0; alarmSound.play();
  desktop.classList.add('glitch');
  setTimeout(()=>desktop.classList.remove('glitch'), 1000);
}
function triggerGlitch(){
  desktop.classList.add('glitch');
  setTimeout(()=>desktop.classList.remove('glitch'), 1400);
}
function triggerWarning(msg){
  showModal(`<div class="alarm">${msg}<br><button class="modal-btn" onclick="hideModal()">OK</button></div>`);
  playClick();
}

/* ========== ZUFÄLLIGE NETZWERK-WARNUNG ========== */
setInterval(()=>{
  if(Math.random()<0.18){
    let n = document.createElement('div');
    n.textContent = "Warnung: Netzwerkverbindung instabil.";
    n.style.position="fixed";
    n.style.bottom="54px";
    n.style.left="50%";
    n.style.transform="translateX(-50%)";
    n.style.background="#222";
    n.style.color="#ffda3a";
    n.style.padding="10px 32px";
    n.style.borderRadius="8px";
    n.style.fontSize="1.1em";
    n.style.zIndex="3000";
    n.style.boxShadow="0 0 12px #000b";
    document.body.appendChild(n);
    setTimeout(()=>n.remove(), 4400);
  }
}, 25000);
/* === Netzwerkfehler-Simulation für Terminal/Explorer === */
function randomNetworkError(){
  if(Math.random()<0.11) return "Fehler: Netzwerkverbindung unterbrochen.";
  return null;
}
/* ===================== GEHEIME FUNKTIONEN (Cheatcodes etc.) ===================== */
document.addEventListener('keydown',function(e){
  if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='g'){ triggerGlitch(); }
});
setInterval(()=>{
  if(new Date().getHours()>=22 && Math.random()<0.1){
    triggerWarning("Ungewöhnliches Verhalten in SCP-███ beobachtet – Check log?");
  }
},120000);
/* ===================== VOLLILDBILD-FUNKTION ===================== */
function requestFullscreen(){
  let docElm = document.documentElement;
  if (docElm.requestFullscreen) docElm.requestFullscreen();
  else if (docElm.mozRequestFullScreen) docElm.mozRequestFullScreen();
  else if (docElm.webkitRequestFullScreen) docElm.webkitRequestFullScreen();
  else if (docElm.msRequestFullscreen) docElm.msRequestFullscreen();
}
document.addEventListener("fullscreenchange", function() {
  fullscreenHint.classList.add('hidden');
});
setTimeout(()=>{
  if (!document.fullscreenElement) {
    fullscreenHint.classList.remove('hidden');
  }
},1500);

/* ===================== MITARBEITERPROFIL ===================== */
function showProfile(){
  let pw = document.getElementById("profile-window");
  let pc = document.getElementById("profile-content");
  pw.classList.remove("hidden");
  pc.innerHTML = `<h2>Mitarbeiterprofil</h2>
    <div><b>Nutzer:</b> ${loginUser.value||"Unbekannt"}</div>
    <div><b>Clearance-Level:</b> ${clearanceLevel}${clearanceLevel==5?" <span class='profile-badge o5'>O5</span>":""}</div>
    <div><b>Badges:</b> ${(clearanceLevel==5?"<span class='profile-badge o5'>O5</span>, <span class='profile-badge'>Secure</span>, <span class='profile-badge'>Insider</span>":"<span class='profile-badge'>Secure</span>")}</div>
    <div><b>Missionen:</b> Überprüfe SCP-173, Berichte an O5.</div>
    <button class='modal-btn' onclick='hideProfile()'>Schließen</button>`;
}
function hideProfile(){
  document.getElementById("profile-window").classList.add("hidden");
}

/* ===================== INIT ===================== */
window.onload = ()=>{ loginUser.focus(); };
</script>
</body>
</html>
<!-- ...DEIN HEAD & STYLE WIE BISHER... -->
<body>
<!-- LOGIN, LOADING ...wie gehabt... -->

<div id="desktop" class="hidden">
  <div class="desktop-logo-bg"> ... </div>
  <div class="scptitle">SCP Foundation - Secure Terminal Desktop</div>
  <div class="taskbar">
    <div id="scp-start-btn" class="taskbar-btn" style="position:relative;">
      <img src="data:image/svg+xml;utf8,<svg width='36' height='36' viewBox='0 0 64 64' fill='none' xmlns='http://www.w3.org/2000/svg'><circle cx='32' cy='32' r='30' stroke='white' stroke-width='4'/><path d='M32 14 L38 32 L32 50 L26 32 Z' fill='white'/></svg>" style="vertical-align:middle;">
    </div>
    <div class="taskbar-btn" onclick="openWindow('terminal')">Terminal</div>
    <div class="taskbar-btn" onclick="openWindow('database')">SCP-Datenbank</div>
    <div class="taskbar-btn" onclick="openWindow('camera')">Kamera</div>
    <div class="taskbar-btn" onclick="openWindow('notes')">Notizen</div>
    <div class="taskbar-btn" onclick="openWindow('chat')">Chat</div>
    <div class="taskbar-btn" onclick="openWindow('explorer')">Datei-Explorer</div>
    <div class="taskbar-btn" onclick="openWindow('updates')">Updates</div>
    <div class="taskbar-btn" onclick="showProfile()">Profil</div>
    <div id="taskbar-clock" style="margin-left:auto;color:#8fe77b;font-family:inherit;min-width:160px;text-align:right;padding-right:12px;"></div>
  </div>
  <div id="scp-start-menu" class="hidden" style="position:fixed;bottom:44px;left:10px;background:#181d23;border-radius:10px;box-shadow:0 0 24px #000b;padding:18px 28px;z-index:200;min-width:220px;">
    <div style="font-weight:bold;color:#fff;margin-bottom:10px;">SCP Anwendungen</div>
    <div id="scp-app-list"></div>
  </div>
</div>

<!-- Templates für neue Apps -->
<template id="tpl-quiz">
  <div class="window" style="top:160px;left:440px;width:360px">
    <div class="window-header">
      <span>SCP-Quiz</span>
      <span class="window-close" onclick="closeWindow(this)">✕</span>
    </div>
    <div class="window-content" id="quiz-content">
      <b>Quizfrage:</b> <span id="quiz-question"></span><br>
      <input id="quiz-answer" style="padding:6px;width:120px;margin-top:10px;" placeholder="Antwort">
      <button onclick="submitQuiz()" style="padding:6px 14px;margin:10px;">Absenden</button>
      <div id="quiz-feedback" style="margin-top:8px;color:#8fe77b;"></div>
    </div>
  </div>
</template>
<template id="tpl-news">
  <div class="window" style="top:220px;left:540px;width:370px">
    <div class="window-header">
      <span>SCP-News</span>
      <span class="window-close" onclick="closeWindow(this)">✕</span>
    </div>
    <div class="window-content">
      <div>
        <b>Neueste SCP-Meldungen:</b>
        <ul style="padding-left:18px;">
          <li>SCP-682: Testprotokoll aktualisiert.</li>
          <li>SCP-096: Zelle wird gewartet.</li>
          <li>Site-19: Sicherheitsalarm Level 2.</li>
          <li>SCP-173: Bewegungsaktivität erhöht.</li>
        </ul>
      </div>
    </div>
  </div>
</template>
<template id="tpl-archiv">
  <div class="window" style="top:180px;left:660px;width:350px">
    <div class="window-header">
      <span>SCP-Archiv</span>
      <span class="window-close" onclick="closeWindow(this)">✕</span>
    </div>
    <div class="window-content">
      <b>Archivierte SCP-Dateien:</b>
      <ul style="padding-left:18px;" id="archiv-list"></ul>
    </div>
  </div>
</template>
<template id="tpl-containment">
  <div class="window" style="top:90px;left:900px;width:340px">
    <div class="window-header">
      <span>SCP-Containment-Status</span>
      <span class="window-close" onclick="closeWindow(this)">✕</span>
    </div>
    <div class="window-content" id="containment-content"></div>
  </div>
</template>
<!-- Profil bearbeiten Modal -->
<div id="profile-edit-modal" class="hidden" style="position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#23272e;color:#fff;padding:30px;border-radius:10px;box-shadow:0 0 18px #000b;z-index:9999;">
  <div style="margin-bottom:10px;font-weight:bold;">Profil bearbeiten</div>
  <label>Neuer Name: <input id="profile-edit-name" style="padding:6px;width:180px;"></label>
  <button onclick="saveProfileEdit()" style="margin:12px 8px 0 0;padding:7px 24px;border-radius:4px;background:#48a;color:#fff;">Speichern</button>
  <button onclick="closeProfileEdit()" style="margin-top:12px;padding:7px 24px;border-radius:4px;background:#c00;color:#fff;">Abbrechen</button>
</div>

<script>
/* Uhrzeit & Datum */
function updateClock(){
  let d = new Date();
  let h = d.getHours().toString().padStart(2,"0");
  let m = d.getMinutes().toString().padStart(2,"0");
  let s = d.getSeconds().toString().padStart(2,"0");
  let date = d.toLocaleDateString();
  document.getElementById('taskbar-clock').textContent = `${h}:${m}:${s}  ${date}`;
}
setInterval(updateClock, 1000);

/* SCP-Startmenü */
const SCP_APPS = [
  {key:"terminal", label:"Terminal", icon:"💻"},
  {key:"database", label:"SCP-Datenbank", icon:"📚"},
  {key:"camera", label:"Kamera", icon:"📷"},
  {key:"notes", label:"Notizen", icon:"📝"},
  {key:"chat", label:"Chat", icon:"💬"},
  {key:"explorer", label:"Datei-Explorer", icon:"🗂️"},
  {key:"updates", label:"Updates", icon:"🔄"},
  {key:"quiz", label:"SCP-Quiz", icon:"❓"},
  {key:"news", label:"SCP-News", icon:"📰"},
  {key:"archiv", label:"SCP-Archiv", icon:"🗄️"},
  {key:"containment", label:"Containment-Status", icon:"🚨"},
  {key:"profile", label:"Profil", icon:"🧑‍💼"},
];
let scpMenuOpen = false;
document.getElementById('scp-start-btn').onclick = function(){
  playClick();
  const menu = document.getElementById('scp-start-menu');
  if(!scpMenuOpen){
    showSCPMenu();
    scpMenuOpen = true;
  } else {
    menu.classList.add('hidden');
    scpMenuOpen = false;
  }
};
document.getElementById('scp-start-btn').ondblclick = function(){
  playClick();
  showSCPMenu();
};
function showSCPMenu(){
  const menu = document.getElementById('scp-start-menu');
  const list = document.getElementById('scp-app-list');
  list.innerHTML = "";
  SCP_APPS.forEach(app=>{
    let div = document.createElement('div');
    div.className = "scp-app-entry";
    div.style = "cursor:pointer;padding:7px 0;font-size:1em;";
    div.innerHTML = `<span style="font-size:1.3em">${app.icon}</span> <span>${app.label}</span>`;
    div.ondblclick = ()=>{menu.classList.add('hidden'); scpMenuOpen=false; (app.key=="profile"?showProfile():openWindow(app.key));};
    div.onclick = ()=>{playClick();};
    list.appendChild(div);
  });
  menu.classList.remove('hidden');
}

/* Neue Anwendungen */
const QUIZ_QUESTIONS = [
  {q:"Welches SCP ist als 'Die Statue' bekannt?", a:"173"},
  {q:"Wie lautet die Klasse von SCP-682?", a:"Keter"},
  {q:"Wer ist Dr. Bright?", a:"Mitarbeiter"},
  {q:"Was ist die Fähigkeit von SCP-500?", a:"Heilt jede Krankheit"},
];
let quizCurrent = 0;
function initQuiz(wnd){
  let q = QUIZ_QUESTIONS[quizCurrent];
  wnd.querySelector('#quiz-question').textContent = q.q;
  wnd.querySelector('#quiz-answer').value = "";
  wnd.querySelector('#quiz-feedback').textContent = "";
}
function submitQuiz(){
  let wnd = openWindows['quiz'];
  let ans = wnd.querySelector('#quiz-answer').value.trim();
  let correct = QUIZ_QUESTIONS[quizCurrent].a;
  if(ans.toLowerCase() == correct.toLowerCase()){
    wnd.querySelector('#quiz-feedback').textContent = "Richtig!";
    quizCurrent = (quizCurrent+1)%QUIZ_QUESTIONS.length;
    setTimeout(()=>initQuiz(wnd),1300);
  }
  else wnd.querySelector('#quiz-feedback').textContent = "Leider falsch! Richtige Antwort: "+correct;
}
function initArchiv(wnd){
  let list = wnd.querySelector('#archiv-list');
  list.innerHTML = "";
  let archived = SCP_ENTRIES.filter(e => e.num === "001" || e.num === "343" || e.num === "427");
  archived.forEach(e=>{
    let li = document.createElement('li');
    li.textContent = `SCP-${e.num}: ${e.name} [${e.class}]`;
    list.appendChild(li);
  });
}
function initContainment(wnd){
  let cont = wnd.querySelector('#containment-content');
  let danger = ["682","173","096","106"];
  let html = "<b>Status der wichtigsten SCPs:</b><br>";
  SCP_ENTRIES.forEach(e=>{
    if(danger.includes(e.num)){
      html += `<span style="color:#c00;font-weight:bold;">SCP-${e.num}</span>: <span style="color:#f44;">Achtung</span><br>`;
    } else {
      html += `<span style="color:#8fe77b;">SCP-${e.num}</span>: <span style="color:#fff;">Gesichert</span><br>`;
    }
  });
  cont.innerHTML = html;
}
/* openWindow PATCH für neue Anwendungen */
let origOpenWindow = openWindow;
openWindow = function(type){
  playClick();
  if(openWindows[type]) {
    openWindows[type].style.zIndex = Object.keys(openWindows).length + 10;
    return;
  }
  let tpl = document.getElementById(`tpl-${type}`);
  if (!tpl) { if(origOpenWindow) origOpenWindow(type); return; }
  let wnd = tpl.content.firstElementChild.cloneNode(true);
  desktop.appendChild(wnd);
  wnd.querySelector('.window-header').onmousedown = function(e){
    let x = e.clientX, y = e.clientY, startLeft = wnd.offsetLeft, startTop = wnd.offsetTop;
    function move(ev){
      wnd.style.left = (startLeft + ev.clientX - x) + "px";
      wnd.style.top  = (startTop  + ev.clientY - y) + "px";
    }
    function up(){document.removeEventListener('mousemove',move);document.removeEventListener('mouseup',up);}
    document.addEventListener('mousemove',move);
    document.addEventListener('mouseup',up);
  };
  openWindows[type]=wnd;
  switch(type) {
    case 'terminal': initTerminal(wnd); break;
    case 'database': initDatabase(wnd); break;
    case 'camera':   initCamera(wnd); break;
    case 'notes':    initNotes(wnd); break;
    case 'chat':     initChat(wnd); break;
    case 'explorer': initExplorer(wnd); break;
    case 'updates':  initUpdates(wnd); break;
    case 'quiz':     initQuiz(wnd); break;
    case 'news':     break;
    case 'archiv':   initArchiv(wnd); break;
    case 'containment': initContainment(wnd); break;
    case 'profile':  showProfile(); wnd.remove(); break;
  }
}
/* Profil bearbeiten */
let userName = "";
function showProfile(){
  let pw = document.getElementById("profile-window");
  let pc = document.getElementById("profile-content");
  pw.classList.remove("hidden");
  pc.innerHTML = `<h2>Mitarbeiterprofil</h2>
    <div><b>Nutzer:</b> <span id="profile-name">${userName||loginUser.value||"Unbekannt"}</span></div>
    <div><b>Clearance-Level:</b> 3 <span class='profile-badge'>Secure</span></div>
    <div><b>Badges:</b> <span class='profile-badge'>Secure</span></div>
    <div><b>Missionen:</b> Überprüfe SCP-173, Berichte an O5.</div>
    <button class='modal-btn' onclick='showProfileEdit()'>Bearbeiten</button>
    <button class='modal-btn' onclick='hideProfile()' style='margin-left:10px;'>Schließen</button>`;
}
function showProfileEdit(){
  let modal = document.getElementById("profile-edit-modal");
  let inp = document.getElementById("profile-edit-name");
  inp.value = userName||loginUser.value||"Unbekannt";
  modal.classList.remove("hidden");
}
function saveProfileEdit(){
  let inp = document.getElementById("profile-edit-name");
  userName = inp.value.trim();
  document.getElementById("profile-edit-modal").classList.add("hidden");
  showProfile();
}
function closeProfileEdit(){
  document.getElementById("profile-edit-modal").classList.add("hidden");
}
function hideProfile(){
  document.getElementById("profile-window").classList.add("hidden");
}
window.onload = ()=>{
  loginUser.focus();
  updateClock();
};
</script>
</body>
</html>